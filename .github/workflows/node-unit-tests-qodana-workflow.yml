name: "CI: Quality & Qodana"

on:
  workflow_call:
    inputs:
      node-version:
        required: true
        type: string
      disabled-test:
        default: false
        type: boolean
      working-directory:
        default: "."
        type: string

jobs:
  quality:
    runs-on: ubuntu-latest
    permissions:
      contents: read          # necesario para checkout
      #pull-requests: write    # si en el futuro se van a añadir comentarios automáticos en PR
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
          cache-dependency-path: ${{ inputs.working-directory }}/package-lock.json

      - name: Install Dependencies
        run: npm ci --prefer-offline --no-audit --progress=false
        working-directory: ${{ inputs.working-directory }}

      - name: Execute Unit Tests
        if: ${{ inputs.disabled-test == false }}
        run: npm run test
        working-directory: ${{ inputs.working-directory }}

      - name: Define Quality Thresholds
        id: thresholds
        run: |
          # Si disabled-test es true, cobertura requerida = 0. Si no, usa variable de Org o 80%.
          if [ "${{ inputs.disabled-test }}" == "true" ]; then
            echo "coverage=0" >> $GITHUB_OUTPUT
          else
            echo "coverage=${{ vars.ORG_MIN_COVERAGE || 80 }}" >> $GITHUB_OUTPUT
          fi

      - name: Qodana Scan
        uses: JetBrains/qodana-action@v2024.3
        env:
          QODANA_TOKEN: ${{ secrets.QODANA_TOKEN }}
        with:
          args: >-
            --skip-pull,
            --linter,jetbrains/qodana-js:2024.3,
            --project-dir,${{ inputs.working-directory }},
            --fail-threshold,0,
            --coverage-dir,coverage,
            --property,qodana.coverage.target=${{ steps.thresholds.outputs.coverage }},
            --property,qodana.max.duplication=${{ vars.ORG_MAX_DUPLICATION || 5 }},
            --property,qodana.severity=${{ vars.ORG_QODANA_SEVERITY || 'high' }}

      - name: Gate Check
        if: failure()
        run: |
          echo "❌ EL QUALITY GATE FALLÓ: Revisa Cobertura, Duplicidad o Vulnerabilidades Altas."
          exit 1